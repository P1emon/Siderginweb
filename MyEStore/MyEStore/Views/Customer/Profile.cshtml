@model MyEStore.Models.ProfileVM
@{
    Layout = "_Layout";
    ViewData["Title"] = "Quản lý tài khoản | MyEStore";
}

<link href="~/css/profile.css" rel="stylesheet">

<div class="container profile-container">
    <div class="profile-card">
        <div class="profile-card-header">
            <div class="profile-avatar-wrapper">
                <div class="profile-avatar">
                    @(string.IsNullOrEmpty(Model.FullName) ? "U" : Model.FullName.FirstOrDefault().ToString().ToUpper())
                </div>
            </div>
            <h3 class="profile-title">@(string.IsNullOrEmpty(Model.FullName) ? "Người dùng" : Model.FullName)</h3>
            <p class="profile-subtitle">@Model.Email</p>
        </div>

        <div class="profile-body">
            <ul class="nav profile-nav-tabs" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link profile-tab-button active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">
                        <i class="bi bi-person-fill"></i>
                        <span>Thông tin cá nhân</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link profile-tab-button active" id="profile-tab" data-bs-target="#password" type="button" role="tab" aria-controls="password" aria-selected="false">
                        <i class="bi bi-shield-lock-fill"></i>
                        <span>Bảo mật</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link profile-tab-button active" id="profile-tab" data-bs-target="#address" type="button" role="tab" aria-controls="address" aria-selected="false">
                        <i class="bi bi-geo-alt-fill"></i>
                        <span>Địa chỉ</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content profile-tab-content">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                    <div class="profile-section">
                        <h4 class="profile-section-title">
                            <i class="bi bi-person-vcard"></i>
                            Thông tin cá nhân
                        </h4>

                        @if (TempData["Success"] != null)
                        {
                            <div class="profile-alert profile-alert-success">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>@TempData["Success"]</span>
                                <button type="button" class="profile-alert-close" onclick="this.parentElement.style.display='none';">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }

                        @if (TempData["Error"] != null)
                        {
                            <div class="profile-alert profile-alert-danger">
                                <i class="bi bi-exclamation-circle-fill"></i>
                                <span>@TempData["Error"]</span>
                                <button type="button" class="profile-alert-close" onclick="this.parentElement.style.display='none';">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }

                        <form asp-action="Profile" method="post" id="profileForm" class="profile-form">
                            <div class="profile-form-group">
                                <label asp-for="FullName" class="profile-form-label">Họ và Tên</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-person-fill"></i>
                                    <input asp-for="FullName" class="profile-form-control" readonly />
                                    <button type="button" class="profile-edit-button" onclick="toggleEdit(this, 'FullName')">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="FullName" class="profile-validation-error"></span>
                            </div>

                            <div class="profile-form-group">
                                <label asp-for="Email" class="profile-form-label">Email</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-envelope-fill"></i>
                                    <input asp-for="Email" type="email" class="profile-form-control" readonly />
                                    <button type="button" class="profile-edit-button" onclick="toggleEdit(this, 'Email')">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Email" class="profile-validation-error"></span>
                            </div>

                            <div class="profile-form-group">
                                <label asp-for="PhoneNumber" class="profile-form-label">Số điện thoại</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-telephone-fill"></i>
                                    <input asp-for="PhoneNumber" type="tel" class="profile-form-control" readonly />
                                    <button type="button" class="profile-edit-button" onclick="toggleEdit(this, 'PhoneNumber')">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="PhoneNumber" class="profile-validation-error"></span>
                            </div>

                            <button type="submit" class="profile-primary-button" id="saveBtn" disabled>
                                <i class="bi bi-check2-circle"></i>
                                <span>Lưu thay đổi</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Password Tab -->
                <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="security-tab">
                    <div class="profile-section">
                        <h4 class="profile-section-title">
                            <i class="bi bi-shield-lock"></i>
                            Đổi mật khẩu
                        </h4>

                        <form asp-action="ChangePassword" method="post" class="profile-form">
                            <div class="profile-form-group">
                                <label for="Password" class="profile-form-label">Mật khẩu hiện tại</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-lock-fill"></i>
                                    <input type="password" id="Password" name="Password" class="profile-form-control" placeholder="Nhập mật khẩu hiện tại" required />
                                    <button type="button" class="profile-toggle-password" onclick="togglePasswordVisibility(this.parentElement)">
                                        <i class="bi bi-eye-slash-fill"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="profile-form-group">
                                <label for="NewPassword" class="profile-form-label">Mật khẩu mới</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-lock-fill"></i>
                                    <input type="password" id="NewPassword" name="NewPassword" class="profile-form-control" placeholder="Nhập mật khẩu mới" required />
                                    <button type="button" class="profile-toggle-password" onclick="togglePasswordVisibility(this.parentElement)">
                                        <i class="bi bi-eye-slash-fill"></i>
                                    </button>
                                </div>
                                <div class="profile-password-strength">
                                    <div class="strength-bar">
                                        <div class="strength-indicator" id="passwordStrength"></div>
                                    </div>
                                    <span id="strengthText">Độ mạnh mật khẩu</span>
                                </div>
                            </div>

                            <div class="profile-form-group">
                                <label for="ConfirmPassword" class="profile-form-label">Xác nhận mật khẩu</label>
                                <div class="profile-input-container">
                                    <i class="bi bi-lock-fill"></i>
                                    <input type="password" id="ConfirmPassword" name="ConfirmPassword" class="profile-form-control" placeholder="Nhập lại mật khẩu mới" required />
                                    <button type="button" class="profile-toggle-password" onclick="togglePasswordVisibility(this.parentElement)">
                                        <i class="bi bi-eye-slash-fill"></i>
                                    </button>
                                </div>
                            </div>

                            <button type="submit" class="profile-primary-button">
                                <i class="bi bi-key-fill"></i>
                                <span>Cập nhật mật khẩu</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Address Tab -->
                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                    <div class="profile-section">
                        <h4 class="profile-section-title">
                            <i class="bi bi-pin-map-fill"></i>
                            Địa chỉ giao hàng
                        </h4>

                        <div class="profile-address-card">
                            <div class="profile-address-content">
                                <div class="profile-address-icon">
                                    <i class="bi bi-house-door-fill"></i>
                                </div>
                                <div class="profile-address-text">
                                    <h5>Địa chỉ hiện tại</h5>
                                    <p>@(string.IsNullOrEmpty(Model.DiaChi) ? "Bạn chưa cung cấp địa chỉ" : Model.DiaChi)</p>
                                </div>
                            </div>
                            <button type="button" class="profile-address-edit" data-bs-toggle="collapse" data-bs-target="#addressFormCollapse" aria-expanded="false" aria-controls="addressFormCollapse">
                                <i class="bi bi-pencil-fill"></i>
                                <span>Chỉnh sửa</span>
                            </button>
                        </div>

                        <div class="collapse" id="addressFormCollapse">
                            <div class="profile-address-form-wrapper">
                                <form id="addressForm" asp-action="UpdateAddress" method="post" class="profile-form">
                                    <div class="profile-form-row">
                                        <div class="profile-form-group">
                                            <label for="province" class="profile-form-label">Tỉnh/Thành phố</label>
                                            <div class="profile-input-container">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <select id="province" name="province" class="profile-form-select" required>
                                                    <option value="">Chọn Tỉnh/Thành phố</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="profile-form-group">
                                            <label for="district" class="profile-form-label">Quận/Huyện</label>
                                            <div class="profile-input-container">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <select id="district" name="district" class="profile-form-select" required>
                                                    <option value="">Chọn Quận/Huyện</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="profile-form-row">
                                        <div class="profile-form-group">
                                            <label for="ward" class="profile-form-label">Phường/Xã</label>
                                            <div class="profile-input-container">
                                                <i class="bi bi-geo-alt-fill"></i>
                                                <select id="ward" name="ward" class="profile-form-select" required>
                                                    <option value="">Chọn Phường/Xã</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="profile-form-group">
                                            <label for="streetAddress" class="profile-form-label">Địa chỉ cụ thể</label>
                                            <div class="profile-input-container">
                                                <i class="bi bi-signpost-fill"></i>
                                                <input type="text" id="streetAddress" name="streetAddress" class="profile-form-control" placeholder="Số nhà, tên đường" required>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="profile-address-preview">
                                        <h5><i class="bi bi-check-circle"></i> Địa chỉ đầy đủ</h5>
                                        <p id="fullAddress" class="profile-full-address">Vui lòng nhập thông tin địa chỉ</p>
                                        <input type="hidden" id="DiaChi" name="diaChi" value="@Model.DiaChi">
                                    </div>

                                    <div class="profile-form-actions">
                                        <button type="button" class="profile-secondary-button" data-bs-toggle="collapse" data-bs-target="#addressFormCollapse">
                                            <i class="bi bi-x-circle"></i>
                                            <span>Hủy</span>
                                        </button>
                                        <button type="submit" class="profile-primary-button">
                                            <i class="bi bi-check2-circle"></i>
                                            <span>Lưu địa chỉ</span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        @if (TempData["AddressSuccess"] != null)
                        {
                            <div class="profile-alert profile-alert-success">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>@TempData["AddressSuccess"]</span>
                                <button type="button" class="profile-alert-close" onclick="this.parentElement.style.display='none';">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }

                        @if (TempData["AddressError"] != null)
                        {
                            <div class="profile-alert profile-alert-danger">
                                <i class="bi bi-exclamation-circle-fill"></i>
                                <span>@TempData["AddressError"]</span>
                                <button type="button" class="profile-alert-close" onclick="this.parentElement.style.display='none';">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle edit mode for profile fields
        function toggleEdit(button, fieldName) {
            const inputContainer = button.closest('.profile-input-container');
            const input = inputContainer.querySelector(`[name="${fieldName}"]`);
            const icon = button.querySelector('i');

            if (input.hasAttribute('readonly')) {
                input.removeAttribute('readonly');
                input.focus();
                icon.classList.replace('bi-pencil-fill', 'bi-check-fill');
                inputContainer.classList.add('is-editing');
                document.getElementById('saveBtn').disabled = false;
            } else {
                input.setAttribute('readonly', '');
                icon.classList.replace('bi-check-fill', 'bi-pencil-fill');
                inputContainer.classList.remove('is-editing');
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility(container) {
            const input = container.querySelector('input');
            const icon = container.querySelector('.profile-toggle-password i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
            } else {
                input.type = 'password';
                icon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
            }
        }

        // Evaluate password strength
        function evaluatePasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            if (!password) {
                strengthBar.style.width = '0%';
                strengthBar.className = 'strength-indicator';
                strengthText.textContent = 'Độ mạnh mật khẩu';
                return;
            }

            let strength = 0;

            // Length check
            if (password.length >= 8) strength += 25;

            // Character variety checks
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            if (/[^A-Za-z0-9]/.test(password)) strength += 25;

            // Update UI
            strengthBar.style.width = strength + '%';

            if (strength <= 25) {
                strengthBar.className = 'strength-indicator weak';
                strengthText.textContent = 'Yếu';
            } else if (strength <= 50) {
                strengthBar.className = 'strength-indicator medium';
                strengthText.textContent = 'Trung bình';
            } else if (strength <= 75) {
                strengthBar.className = 'strength-indicator good';
                strengthText.textContent = 'Khá mạnh';
            } else {
                strengthBar.className = 'strength-indicator strong';
                strengthText.textContent = 'Mạnh';
            }
        }

        // Address Form Handling
        document.addEventListener('DOMContentLoaded', function () {
            // Setup password strength meter
            const newPasswordInput = document.getElementById('NewPassword');
            if (newPasswordInput) {
                newPasswordInput.addEventListener('input', function () {
                    evaluatePasswordStrength(this.value);
                });
            }

            // Add ripple effect to buttons
            const buttons = document.querySelectorAll('.profile-primary-button, .profile-secondary-button, .profile-edit-button, .profile-address-edit');

            buttons.forEach(button => {
                button.addEventListener('click', function (e) {
                    const x = e.clientX - e.target.getBoundingClientRect().left;
                    const y = e.clientY - e.target.getBoundingClientRect().top;

                    const ripple = document.createElement('span');
                    ripple.classList.add('profile-ripple');
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;

                    this.appendChild(ripple);

                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });

            // Tab animation
            const tabButtons = document.querySelectorAll('.profile-nav-tabs .nav-link');
            const indicator = document.createElement('span');
            indicator.className = 'profile-nav-indicator';

            if (tabButtons.length > 0) {
                document.querySelector('.profile-nav-tabs').appendChild(indicator);

                function positionIndicator(activeTab) {
                    const rect = activeTab.getBoundingClientRect();
                    const parentRect = activeTab.closest('.profile-nav-tabs').getBoundingClientRect();

                    indicator.style.left = `${rect.left - parentRect.left}px`;
                    indicator.style.width = `${rect.width}px`;
                }

                // Initial position
                positionIndicator(document.querySelector('.profile-nav-tabs .nav-link.active'));

                // Update on tab click
                tabButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        positionIndicator(this);
                    });
                });

                // Update on window resize
                window.addEventListener('resize', function () {
                    positionIndicator(document.querySelector('.profile-nav-tabs .nav-link.active'));
                });
            }

            // Address Form Logic
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            const streetAddressInput = document.getElementById('streetAddress');
            const fullAddressDisplay = document.getElementById('fullAddress');
            const diaChiInput = document.getElementById('DiaChi');

            if (!provinceSelect) return;

            // Loading states
            function setLoading(select, loading) {
                select.disabled = loading;
                const container = select.closest('.profile-input-container');

                if (loading) {
                    container.classList.add('is-loading');

                    if (!container.querySelector('.profile-loading-spinner')) {
                        const spinner = document.createElement('div');
                        spinner.className = 'profile-loading-spinner';
                        container.appendChild(spinner);
                    }
                } else {
                    container.classList.remove('is-loading');

                    const spinner = container.querySelector('.profile-loading-spinner');
                    if (spinner) spinner.remove();
                }
            }

            // Fetch provinces
            async function loadProvinces() {
                try {
                    setLoading(provinceSelect, true);
                    const response = await fetch('https://provinces.open-api.vn/api/p/');

                    if (!response.ok) throw new Error('Network response was not ok');

                    const data = await response.json();

                    provinceSelect.innerHTML = '<option value="">Chọn Tỉnh/Thành phố</option>';

                    data.forEach(province => {
                        const option = new Option(province.name, province.code);
                        provinceSelect.add(option);
                    });
                } catch (error) {
                    console.error('Error loading provinces:', error);
                    showAddressError('Không thể tải danh sách tỉnh/thành phố. Vui lòng thử lại sau.');
                } finally {
                    setLoading(provinceSelect, false);
                }
            }

            // Show error message for address
            function showAddressError(message) {
                const errorContainer = document.createElement('div');
                errorContainer.className = 'profile-alert profile-alert-danger';
                errorContainer.innerHTML = `
                            <i class="bi bi-exclamation-circle-fill"></i>
                            <span>${message}</span>
                            <button type="button" class="profile-alert-close" onclick="this.parentElement.remove();">
                                <i class="bi bi-x"></i>
                            </button>
                        `;

                const addressForm = document.getElementById('addressForm');
                addressForm.parentNode.insertBefore(errorContainer, addressForm);

                setTimeout(() => {
                    errorContainer.remove();
                }, 5000);
            }

            // Handle province change
            provinceSelect.addEventListener('change', async function () {
                districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                if (this.value) {
                    try {
                        setLoading(districtSelect, true);
                        const response = await fetch(`https://provinces.open-api.vn/api/p/${this.value}?depth=2`);

                        if (!response.ok) throw new Error('Network response was not ok');

                        const data = await response.json();

                        data.districts.forEach(district => {
                            const option = new Option(district.name, district.code);
                            districtSelect.add(option);
                        });
                    } catch (error) {
                        console.error('Error loading districts:', error);
                        showAddressError('Không thể tải danh sách quận/huyện. Vui lòng thử lại sau.');
                    } finally {
                        setLoading(districtSelect, false);
                    }
                }

                updateFullAddress();
            });

            // Handle district change
            districtSelect.addEventListener('change', async function () {
                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';

                if (this.value) {
                    try {
                        setLoading(wardSelect, true);
                        const response = await fetch(`https://provinces.open-api.vn/api/d/${this.value}?depth=2`);

                        if (!response.ok) throw new Error('Network response was not ok');

                        const data = await response.json();

                        data.wards.forEach(ward => {
                            const option = new Option(ward.name, ward.code);
                            wardSelect.add(option);
                        });
                    } catch (error) {
                        console.error('Error loading wards:', error);
                        showAddressError('Không thể tải danh sách phường/xã. Vui lòng thử lại sau.');
                    } finally {
                        setLoading(wardSelect, false);
                    }
                }

                updateFullAddress();
            });

            // Update full address
            function updateFullAddress() {
                const province = provinceSelect.options[provinceSelect.selectedIndex]?.text || '';
                const district = districtSelect.options[districtSelect.selectedIndex]?.text || '';
                const ward = wardSelect.options[wardSelect.selectedIndex]?.text || '';
                const street = streetAddressInput.value.trim();

                let addressParts = [];
                if (street) addressParts.push(street);
                if (ward && ward !== 'Chọn Phường/Xã') addressParts.push(ward);
                if (district && district !== 'Chọn Quận/Huyện') addressParts.push(district);
                if (province && province !== 'Chọn Tỉnh/Thành phố') addressParts.push(province);

                const fullAddress = addressParts.join(', ');

                fullAddressDisplay.textContent = fullAddress || 'Vui lòng nhập thông tin địa chỉ';
                diaChiInput.value = fullAddress;

                // Visualize address completeness
                const addressPreview = document.querySelector('.profile-address-preview');

                if (fullAddress) {
                    addressPreview.classList.add('complete');
                } else {
                    addressPreview.classList.remove('complete');
                }
            }

            // Additional event listeners
            wardSelect.addEventListener('change', updateFullAddress);
            streetAddressInput.addEventListener('input', updateFullAddress);

            // Initialize provinces loading
            loadProvinces();

            // Collapse animation
            const collapseElement = document.getElementById('addressFormCollapse');

            collapseElement.addEventListener('show.bs.collapse', function () {
                this.style.display = 'block';

                setTimeout(() => {
                    this.style.height = this.scrollHeight + 'px';
                    this.style.opacity = '1';
                }, 10);
            });

            collapseElement.addEventListener('hide.bs.collapse', function () {
                this.style.height = '0';
                this.style.opacity = '0';

                setTimeout(() => {
                    this.style.display = 'none';
                }, 300);
            });
        });
    </script>
}