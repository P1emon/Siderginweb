@model dynamic
@Html.Partial("livechat")
<link rel="stylesheet" href="~/css/Orderdetail.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" />
<div class="order-wrapper">
    <nav class="tab-nav">
        <button class="tab-btn active" onclick="showTab('order-details')">Thông tin đơn hàng</button>
        <button class="tab-btn" onclick="showTab('products')">Sản phẩm</button>
        <button class="tab-btn" onclick="showTab('summary')">Tổng kết</button>
    </nav>

    <div class="tab-content">
        <div id="order-details" class="tab-pane active">
            <h2>Đơn hàng #@Model.MaHd</h2>
            <div class="details-grid">
                <div class="detail-item">
                    <span class="label">Ngày đặt</span>
                    <span>@Model.NgayDat.ToString("dd/MM/yyyy")</span>
                </div>
                <div class="detail-item">
                    <span class="label">Khách hàng</span>
                    <span>@Model.HoTen</span>
                </div>
                <div class="detail-item">
                    <span class="label">Địa chỉ</span>
                    <span>@Model.DiaChi</span>
                </div>
                <div class="detail-item">
                    <span class="label">Thanh toán</span>
                    <span>@Model.CachThanhToan</span>
                </div>
            </div>
        </div>

        <div id="products" class="tab-pane">
            <h2>Sản phẩm</h2>
            <div class="product-list">
                @foreach (var product in Model.Products)
                {
                    <div class="product-item">
                        <img src="~/Hinh/HangHoa/@product.Hinh" alt="@product.ProductName" class="product-img" />
                        <div class="product-info">
                            <h3>@product.ProductName</h3>
                            <div class="product-meta">
                                <span>Số lượng: @product.SoLuong</span>
                                <span>Đơn giá: <span class="currency" data-value="@product.DonGia">@product.DonGia</span></span>
                                <span>Tổng: <span class="currency" data-value="@(product.DonGia * product.SoLuong)">@(product.DonGia * product.SoLuong)</span></span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div id="summary" class="tab-pane">
            <h2>Tổng kết</h2>
            <div class="summary-content">
                <div class="summary-item">
                    <span class="label">Mã đơn hàng</span>
                    <span>#@Model.MaHd</span>
                </div>
                <div class="summary-item">
                    <span class="label">Tổng cộng</span>
                    <span id="totalPrice">0.00</span>
                    <span id="currencySymbol">VND</span>
                </div>
                <div class="currency-select">
                    <label for="currency">Tiền tệ:</label>
                    <select id="currency" onchange="updateCurrency()">
                        <option value="VND" selected>VND</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-print" onclick="window.print()">In đơn hàng</button>
</div>

<script>
    function showTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    function updateCurrency() {
        const currency = document.getElementById("currency").value;
        let total = 0;
        const products = document.querySelectorAll(".product-item");

        products.forEach(product => {
            const unitPrice = parseFloat(product.querySelectorAll(".currency")[0].dataset.value);
            const quantity = parseInt(product.querySelector(".product-meta span:nth-child(1)").textContent.split(": ")[1]);
            const productTotal = unitPrice * quantity;
            total += productTotal;

            // Update displayed prices
            const priceCells = product.querySelectorAll(".currency");
            priceCells.forEach(cell => {
                const value = parseFloat(cell.dataset.value);
                cell.textContent = currency === "USD" ? (value / 25400).toFixed(2) : value.toFixed(2);
            });
        });

        // Update total and currency symbol
        const finalTotal = currency === "USD" ? total / 25400 : total;
        document.getElementById("totalPrice").textContent = finalTotal.toFixed(2);
        document.getElementById("currencySymbol").textContent = currency;
    }

    // Store original values for currency conversion
    document.querySelectorAll(".currency").forEach(cell => {
        cell.dataset.value = cell.textContent;
    });

    // Initialize currency on page load
    updateCurrency();
</script>